<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout Page</title>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { padding: 10px; margin: 5px; }
    .paypal-button { background-color: #FFD140; color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Checkout</h1>

  <h2>Shipping Details</h2>
  <input id="shippingName" type="text" placeholder="Full Name"><br>
  <input id="shippingAddress" type="text" placeholder="Shipping Address"><br>
  <input id="shippingPhone" type="text" placeholder="Phone Number"><br>

  <h2>Cart Summary</h2>
  <div id="cartItems"></div>
  <h3>Total: <span id="totalPrice">0</span> LKR</h3>

  <button onclick="completePurchase()">Place Order</button>

  <form action="https://www.paypal.com/ncp/payment/CXY27CU5SZ988" method="post" target="_blank">
    <input class="paypal-button" type="submit" value="Pay with PayPal" />
    <img src="https://www.paypalobjects.com/images/Debit_Credit.svg" alt="cards" height="20">
  </form>

  <script>
    emailjs.init('tldy827nNeolKsVgO'); // Your EmailJS user ID

    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const cartContainer = document.getElementById('cartItems');
      let total = 0;
      cartContainer.innerHTML = '';
      cart.forEach(item => {
        const line = document.createElement('div');
        line.textContent = `${item.name} - ${item.quantity} x ${item.price} LKR`;
        cartContainer.appendChild(line);
        total += item.quantity * item.price;
      });
      document.getElementById('totalPrice').innerText = total;
    }

    function sendOrderEmail(cart, shippingDetails, totalPrice) {
      const productList = cart.map(item =>
        `${item.name} - ${item.quantity} x ${item.price} LKR`
      ).join('\n');

      const templateParams = {
        name: shippingDetails.name,
        address: shippingDetails.address,
        phone: shippingDetails.phone,
        products: productList,
        total: totalPrice + ' LKR'
      };

      emailjs.send('service_vwz25ea', 'template_bd4d37e', templateParams)
        .then(response => {
          console.log('SUCCESS!', response.status, response.text);
        }, error => {
          console.log('FAILED...', error);
        });
    }

    function completePurchase() {
      const name = document.getElementById('shippingName').value;
      const address = document.getElementById('shippingAddress').value;
      const phone = document.getElementById('shippingPhone').value;

      if (!name || !address || !phone) {
        alert('Please fill in all shipping details.');
        return;
      }

      const shippingDetails = { name, address, phone };
      const totalPrice = document.getElementById('totalPrice').innerText;
      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      sendOrderEmail(cart, shippingDetails, totalPrice);

      localStorage.removeItem('cart');
      alert('Order placed! You will receive an email confirmation.');
      window.location.href = 'thankyou.html';
    }

    loadCart();
  </script>
</body>
</html>
